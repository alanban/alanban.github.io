<html>
<head>
  <title>Java 优雅的终止线程</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303502 (zh-CN, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="563"/>
<h1>Java 优雅的终止线程</h1>

<div>
<span><div><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; text-indent: 21pt; background-color: rgb(255, 255, 255);"><span style="font-family: Tahoma; font-size: 16px;"><span style="font-size: 12pt; font-family: 宋体;"><a href="http://lib.csdn.net/base/17" target="_blank">Java</a>中原来在<span style="font-family: Arial;">Thread</span>中提供了<span style="font-family: Arial;">stop()</span>方法来终止线程，但这个方法是不安全的，所以一般不建议使用。《<span style="font-family: Arial;">Java</span>多线程模式》中有一种叫<span style="font-family: Arial;">Two-Phase Termination</span>（两步终止）的模式可以优雅的终止线程。</span></span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; text-indent: 21pt; background-color: rgb(255, 255, 255);"><span style="font-size: 12pt; font-family: 宋体;">首先在线程中设置一个标志位：</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; text-indent: 21pt; background-color: rgb(255, 255, 255);"><span style="font-size: 10.5pt; font-family: 宋体;">private volatile boolean shutdownRequested = false;</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; text-indent: 21pt; background-color: rgb(255, 255, 255);"><span style="font-size: 12pt; font-family: 宋体;">然后在运行函数里，以这个标志位来判断是否执行操作：</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; background-color: rgb(255, 255, 255);"><span style="font-size: 10.5pt; font-family: 'Times New Roman';">    public final void run() {</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; background-color: rgb(255, 255, 255);"><span style="font-size: 10.5pt; font-family: 'Times New Roman';">        try {</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; background-color: rgb(255, 255, 255);"><span style="font-size: 10.5pt; font-family: 'Times New Roman';">            while (!shutdownRequested) {</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; background-color: rgb(255, 255, 255);"><span style="font-size: 10.5pt; font-family: 'Times New Roman';">                doWork();</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; background-color: rgb(255, 255, 255);"><span style="font-size: 10.5pt; font-family: 'Times New Roman';">            }</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; background-color: rgb(255, 255, 255);"><span style="font-size: 10.5pt; font-family: 'Times New Roman';">        } catch (InterruptedException e) {</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; background-color: rgb(255, 255, 255);"><span style="font-size: 10.5pt; font-family: 'Times New Roman';">        } finally {</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; background-color: rgb(255, 255, 255);"><span style="font-size: 10.5pt; font-family: 'Times New Roman';">            doShutdown();</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; background-color: rgb(255, 255, 255);"><span style="font-size: 10.5pt; font-family: 'Times New Roman';">        }</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; text-indent: 21pt; background-color: rgb(255, 255, 255);"><span style="font-size: 10.5pt; font-family: 'Times New Roman';"> }</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; background-color: rgb(255, 255, 255);"><span style="font-size: 12pt; font-family: 宋体;">然后提供<span style="font-family: Arial;">shutdown()</span>接口供外部调用：</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; background-color: rgb(255, 255, 255);"><span style="font-size: 10.5pt; font-family: 宋体;">    public final void shutdownRequest() {</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; background-color: rgb(255, 255, 255);"><span style="font-size: 10.5pt; font-family: 宋体;">        shutdownRequested = true;</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; background-color: rgb(255, 255, 255);"><span style="font-size: 10.5pt; font-family: 宋体;">        interrupt();</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; background-color: rgb(255, 255, 255);"><span style="font-size: 10.5pt; font-family: 宋体;">    }</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; background-color: rgb(255, 255, 255);"><span style="font-size: 12pt; font-family: 宋体;">客户可以这样子使用：</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; background-color: rgb(255, 255, 255);"><span style="font-size: 10.5pt; font-family: 宋体;">thread.shutdown()</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; background-color: rgb(255, 255, 255);"><span style="font-size: 10.5pt; font-family: 宋体;">thread.join()</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; background-color: rgb(255, 255, 255);"><span style="font-size: 12pt; font-family: 宋体;">这个模式中采用了两个步骤来终止线程，所以叫两步终止模式。第一步，先将执行标志位</span><span style="font-size: 12pt; font-family: 宋体;">shutdownRequested 设为</span><span style="font-size: 12pt; font-family: 宋体;">false，是作业中的线程转变为终止处理中的状态，第二部才是真正去执行终止操作。这样的做法可以保证线程的安全性、生命性和响应性。</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; background-color: rgb(255, 255, 255);"><span style="font-size: 12pt; font-family: 宋体;">（1）</span><span style="font-size: 12pt; font-family: 宋体;">安全性：不会在线程正在执行关键区域<span style="font-family: Arial;">--Critical Section</span>的时候突然结束掉</span></p><p style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; background-color: rgb(255, 255, 255);"><span style="font-size: 12pt; font-family: 宋体;">（2）</span><span style="font-size: 12pt; font-family: 宋体;">生命性：一定会进行终止处理，<span style="font-family: Arial;">shutdown()</span>中，会调用<span style="font-family: Arial;">interrupt()</span>，保证即使线程处于<span style="font-family: Arial;">sleep</span>或<span style="font-family: Arial;">wait</span>状态也可以被立即终止，而客户端调用<span style="font-family: Arial;">shutdown</span>（）之后，会调用<span style="font-family: Arial;">join()</span>，保证了这个线程会执行完，也就确保了终止操作<span style="font-family: Arial;">doshutdown()</span>一定会执行</span></p><div style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial; background-color: rgb(255, 255, 255); font-size: 14px;"><div><span style="font-size: 12pt; font-family: 宋体;">（3）</span><span style="font-size: 12pt; font-family: 宋体;">响应性：将</span><span style="font-size: 12pt; font-family: 宋体;">shutdownRequested 设为<span style="font-family: Arial;">volatile </span>，能保证线程收到终止请求后，会尽快开始终止处理</span><span style="font-size: 12pt; font-family: 宋体;">。</span></div></div></div></span>
</div></body></html> 