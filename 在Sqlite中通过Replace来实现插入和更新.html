<html>
<head>
  <title>在Sqlite中通过Replace来实现插入和更新</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303502 (zh-CN, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="777"/>
<h1>在Sqlite中通过Replace来实现插入和更新</h1>

<div>
<span><div><span style="color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 14px; font-family: 'Lucida Grande', 'Lucida Sans Unicode', Arial, 宋体, Helvetica, sans-serif; background-color: rgb(255, 255, 255);">在数据库中我们经常会有这种需求，</span><span style="color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 14px; font-family: 'Lucida Grande', 'Lucida Sans Unicode', Arial, 宋体, Helvetica, sans-serif; background-color: rgb(255, 255, 255);">插入时，某条记录不存在则插入，存在则更新。或更新时，某条记录存在则更新，不存在则插入</span><span style="color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 14px; font-family: 'Lucida Grande', 'Lucida Sans Unicode', Arial, 宋体, Helvetica, sans-serif; background-color: rgb(255, 255, 255);">。比如： </span><br style="color: rgb(0, 0, 0); font-family: 'sans serif', tahoma, verdana, helvetica; font-size: 12px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px;"/><span style="color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 14px; font-family: 'Lucida Grande', 'Lucida Sans Unicode', Arial, 宋体, Helvetica, sans-serif; background-color: rgb(255, 255, 255);">人员信息数据库，某个SFZ若已经存在，重复插入则更新，否则新增记录。 </span><br style="color: rgb(0, 0, 0); font-family: 'sans serif', tahoma, verdana, helvetica; font-size: 12px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px;"/><span style="color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 14px; font-family: 'Lucida Grande', 'Lucida Sans Unicode', Arial, 宋体, Helvetica, sans-serif; background-color: rgb(255, 255, 255);">网页缓存数据库，某个url已经存在，重复插入则更新，否则新增记录。 </span><br style="color: rgb(0, 0, 0); font-family: 'sans serif', tahoma, verdana, helvetica; font-size: 12px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px;"/><br style="color: rgb(0, 0, 0); font-family: 'sans serif', tahoma, verdana, helvetica; font-size: 12px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px;"/><p style="word-wrap: break-word; margin: 5px 0px; color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-family: Arial; font-size: 14px; background-color: rgb(255, 255, 255);"><span style="font-family: 'Lucida Grande', 'Lucida Sans Unicode', Arial, 宋体, Helvetica, sans-serif;">在mysql中可以使用replace into或是insert into …. on duplicate key update实现。在sqlite中我们同样可以使用replace into实现。分为两步，下面以http cache表为例，仅包含三个字段，主键_id, url, content </span></p><div style="word-wrap: break-word; margin: 5px 0px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-size: 14px;"><span style="font-family: 'Lucida Grande', 'Lucida Sans Unicode', Arial, 宋体, Helvetica, sans-serif;">第一步：新建唯一索引: CREATE UNIQUE INDEX mycolumn_index ON mytable (myclumn); <br/>
CREATE UNIQUE INDEX unique_index_url ON http_cache (url); </span></span><div><span style="font-size: 14px;"><span style="font-family: 'Lucida Grande', 'Lucida Sans Unicode', Arial, 宋体, Helvetica, sans-serif;">java中可以直接在SQLiteOpenHelper的OnCreate中添加 </span></span></div><div><ol style="font-family: Consolas, 'Courier New', Courier, mono, serif; font-size: 12px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(92, 92, 92); background-color: rgb(255, 255, 255);"><li style="color: inherit;"><span style="color: black; background-color: inherit;"><span style="color: rgb(0, 102, 153); font-weight: bold; background-color: inherit;">public</span><span style="background-color: inherit;"> </span><span style="color: rgb(0, 102, 153); font-weight: bold; background-color: inherit;">class</span><span style="background-color: inherit;"> DbHelper </span><span style="color: rgb(0, 102, 153); font-weight: bold; background-color: inherit;">extends</span><span style="background-color: inherit;"> SQLiteOpenHelper {   </span></span></li><li style="background-color: rgb(248, 248, 248);"><span style="color: black; background-color: inherit;">   <span style="color: rgb(0, 102, 153); font-weight: bold; background-color: inherit;">public</span><span style="background-color: inherit;"> </span><span style="color: rgb(0, 102, 153); font-weight: bold; background-color: inherit;">void</span><span style="background-color: inherit;"> onCreate(SQLiteDatabase db) {  </span></span></li><li style="color: inherit;"><span style="color: black; background-color: inherit;">        db.beginTransaction();  </span></li><li style="background-color: rgb(248, 248, 248);"><span style="color: black; background-color: inherit;">        <span style="color: rgb(0, 102, 153); font-weight: bold; background-color: inherit;">try</span><span style="background-color: inherit;"> {  </span></span></li><li style="color: inherit;"><span style="color: black; background-color: inherit;">            db.execSQL(DbConstants.CREATE_HTTP_RESPONSE_TABLE_UNIQUE_INDEX.toString());  </span></li><li style="background-color: rgb(248, 248, 248);"><span style="color: black; background-color: inherit;">            db.setTransactionSuccessful();  </span></li><li style="color: inherit;"><span style="color: black; background-color: inherit;">        } <span style="color: rgb(0, 102, 153); font-weight: bold; background-color: inherit;">finally</span><span style="background-color: inherit;"> {  </span></span></li><li style="background-color: rgb(248, 248, 248);"><span style="color: black; background-color: inherit;">            db.endTransaction();  </span></li><li style="color: inherit;"><span style="color: black; background-color: inherit;">        }  </span></li><li style="background-color: rgb(248, 248, 248);"><span style="color: black; background-color: inherit;">    }  </span></li><li style="color: inherit;"><span style="color: black; background-color: inherit;">}  </span></li></ol></div><div style="color: inherit;"><span style="background-color: inherit;"><br/></span></div><div><span style="color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 14px; font-family: 'Lucida Grande', 'Lucida Sans Unicode', Arial, 宋体, Helvetica, sans-serif; background-color: rgb(255, 255, 255);">第二步：调用replace into语句</span><span style="color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 14px; font-family: 'Lucida Grande', 'Lucida Sans Unicode', Arial, 宋体, Helvetica, sans-serif; background-color: rgb(255, 255, 255);"> </span><br style="color: rgb(0, 0, 0); font-family: 'sans serif', tahoma, verdana, helvetica; font-size: 12px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px;"/><span style="color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 14px; font-family: 'Lucida Grande', 'Lucida Sans Unicode', Arial, 宋体, Helvetica, sans-serif; background-color: rgb(255, 255, 255);">REPLACE INTO http_cache (url, content) VALUES ('http://www.baidu.com/', '&lt;html&gt;&lt;/html&gt;' ); </span></div><div><span style="color: rgb(0, 0, 0); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 14px; font-family: 'Lucida Grande', 'Lucida Sans Unicode', Arial, 宋体, Helvetica, sans-serif; background-color: rgb(255, 255, 255);">java中可以 </span></div><div><ol style="font-family: Consolas, 'Courier New', Courier, mono, serif; font-size: 12px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(92, 92, 92); background-color: rgb(255, 255, 255);"><li style="color: inherit;"><span style="color: black; background-color: inherit;"><span style="background-color: inherit;">sQLiteDatabase.replace(DbConstants.HTTP_RESPONSE_TABLE_TABLE_NAME, </span><span style="color: rgb(0, 102, 153); font-weight: bold; background-color: inherit;">null</span><span style="background-color: inherit;">, contentValues)  </span></span></li></ol></div></div></div></span>
</div></body></html> 